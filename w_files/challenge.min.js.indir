var LichessChallenge=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,o,i){return{sel:e,data:t,children:n,text:o,elm:i,key:void 0===t?void 0:t.key}}const n=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function i(e){return void 0===e}function r(e){return void 0!==e}const l=t("",{},[],void 0,void 0);function a(e,t){var n,o;const i=e.key===t.key,r=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&i&&r}function s(e,t,n){var o;const i={};for(let r=t;r<=n;++r){const t=null===(o=e[r])||void 0===o?void 0:o.key;void 0!==t&&(i[t]=r)}return i}const c=["create","update","remove","destroy","pre","post"];function d(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let o=0;o<t.length;++o){const e=t[o].data;void 0!==e&&d(e,t[o].children,t[o].sel)}}function u(e,i,r){let l,a,s,c={};if(void 0!==r?(null!==i&&(c=i),n(r)?l=r:o(r)?a=r:r&&r.sel&&(l=[r])):null!=i&&(n(i)?l=i:o(i)?a=i:i&&i.sel?l=[i]:c=i),void 0!==l)for(s=0;s<l.length;++s)o(l[s])&&(l[s]=t(void 0,void 0,void 0,l[s],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||d(c,l,e),t(e,c,l,a,void 0)}function h(e,t){let n;const o=t.elm;let i=e.data.attrs,r=t.data.attrs;if((i||r)&&i!==r){for(n in i=i||{},r=r||{},r){const e=r[n];i[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in i)n in r||o.removeAttribute(n)}}function f(e,t){let n,o;const i=t.elm;let r=e.data.class,l=t.data.class;if((r||l)&&r!==l){for(o in r=r||{},l=l||{},r)r[o]&&!Object.prototype.hasOwnProperty.call(l,o)&&i.classList.remove(o);for(o in l)n=l[o],n!==r[o]&&i.classList[n?"add":"remove"](o)}}const p={Accept:"application/vnd.lichess.v5+json"},m={cache:"no-cache",credentials:"same-origin"},g={"X-Requested-With":"XMLHttpRequest"};function v(e){if(e.ok)return e;if(429==e.status)throw new Error("Too many requests");if(413==e.status)throw new Error("The uploaded file is too large");throw new Error(`Error ${e.status}`)}const w=(e,t={})=>b(e,t).then((e=>v(e).text())),b=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},m),{headers:Object.assign({},g)}),t)),y=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t};let k=[],x=!1;function C(e){const t=lichess.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(t.get(),10)<1e3)return;t.set(""+Date.now()),$.isFunction(e)&&(e=e());const n=new Notification("lichess.org",{icon:lichess.assetUrl("logo/lichess-favicon-256.png",{noVersion:!0}),body:e});n.onclick=()=>window.focus(),k.push(n),x||(x=!0,window.addEventListener("focus",(()=>{k.forEach((e=>e.close())),k=[]})))}function N(e,t,n){let o=e=>e,i=!1,r={};function l(n){t=n,n.i18n&&(o=lichess.trans(n.i18n).noarg),n.reasons&&(r=n.reasons),e.setCount(t.in.filter((e=>!e.declined)).length),t.in.forEach((n=>{var o;lichess.once("c-"+n.id)&&(!lichess.quietMode&&t.in.length<=3&&(e.show(),lichess.sound.play("newChallenge")),!(parseInt(lichess.storage.get("push-subscribed")||"0",10)+864e5>=Date.now())&&n.challenger&&(o=function(e){const t=e.rating+(e.provisional?"?":"");return(e.title?e.title+" ":"")+e.name+" ("+t+")"}(n.challenger)+" challenges you!",!document.hasFocus()&&"Notification"in window&&"granted"===Notification.permission&&setTimeout(C,10+500*Math.random(),o)),e.pulse())}))}return l(t),{data:()=>t,trans:()=>o,reasons:()=>r,update:l,decline(e,n){t.in.forEach((t=>{t.id===e&&(t.declined=!0,w(`/challenge/${e}/decline`,{method:"post",body:y({reason:n})}).catch((()=>lichess.announce({msg:"Failed to send challenge decline"}))))}))},cancel(e){t.out.forEach((t=>{t.id===e&&(t.declined=!0,w(`/challenge/${e}/cancel`,{method:"post"}).catch((()=>lichess.announce({msg:"Failed to send challenge cancellation"}))))}))},redirecting:()=>i,onRedirect(){i=!0,requestAnimationFrame(n)}}}const j=[{"stroke-width":3.779,d:"m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"},{"stroke-width":4.157,d:"m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"},{"stroke-width":4.535,d:"m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"}];function O(e){return e.redirecting()?u("div#challenge-app.dropdown",u("div.initiating",u("div.spinner",{"aria-label":"loading"},[u("svg",{attrs:{viewBox:"-2 -2 54 54"}},[u("g",{attrs:{mask:"url(#mask)",fill:"none",stroke:"#888","stroke-dasharray":1}},j.map((e=>u("path",{attrs:Object.assign({pathLength:1},e)}))))])]))):u("div#challenge-app.links.dropdown.rendered",function(e){const t=e.data(),n=t.in.length+t.out.length;return n?[E(e,t,n)]:[q(),M()]}(e))}function T(e){lichess.powertip.manualUserIn(e.elm)}function E(e,t,n){return u("div.challenges",{class:{many:n>3},hook:{insert:T,postpatch:T}},t.in.map(A(e,"in")).concat(t.out.map(A(e,"out"))))}function A(e,t){return n=>u("div.challenge."+t+".c-"+n.id,{class:{declined:!!n.declined}},[u("div.content",[u("span.head",F("in"===t?n.challenger:n.destUser)),u("span.desc",[u("span.is.is2.color-icon."+(n.color||"random"))," • ",[e.trans()(n.rated?"rated":"casual"),S(n.timeControl),n.variant.name].join(" • ")])]),u("i",{attrs:{"data-icon":n.perf.icon}}),u("div.buttons",("in"===t?B:L)(e,n))])}function B(e,t){const n=e.trans();return[u("form",{attrs:{method:"post",action:`/challenge/${t.id}/accept`}},[u("button.button.accept",{attrs:{type:"submit","data-icon":"",title:n("accept")},hook:D(e.onRedirect)})]),u("button.button.decline",{attrs:{type:"submit","data-icon":"",title:n("decline")},hook:D((()=>e.decline(t.id,"generic")))}),u("select.decline-reason",{hook:{insert:n=>{const o=n.elm;o.addEventListener("change",(()=>e.decline(t.id,o.value)))}}},Object.entries(e.reasons()).map((([e,t])=>u("option",{attrs:{value:e}},"generic"==e?"":t))))]}function L(e,t){const n=e.trans();return[u("div.owner",[u("span.waiting",e.trans()("waiting")),u("a.view",{attrs:{"data-icon":"",href:"/"+t.id,title:n("viewInFullSize")}})]),u("button.button.decline",{attrs:{"data-icon":"",title:n("cancel")},hook:D((()=>e.cancel(t.id)))})]}function S(e){switch(e.type){case"unlimited":return"Unlimited";case"correspondence":return e.daysPerTurn+" days";case"clock":return e.show||"-"}}function F(e){if(!e)return u("span","Open challenge");const t=e.rating+(e.provisional?"?":"");return u("a.ulpt.user-link",{attrs:{href:`/@/${e.name}`},class:{online:!!e.online}},[u("i.line"+(e.patron?".patron":"")),u("name",[e.title&&u("span.utitle","BOT"==e.title?{attrs:{"data-bot":!0}}:{},e.title+" "),e.name+" ("+t+") "]),u("signal",void 0===e.lag?[]:[1,2,3,4].map((t=>u("i",{class:{off:e.lag<t}}))))])}function M(){return u("a.create",{attrs:{href:"/?any#friend","data-icon":"",title:"Challenge someone"}})}function q(){return u("div.empty.text",{attrs:{"data-icon":""}},"No challenges.")}function D(e){return{insert:t=>{t.elm.addEventListener("click",e)}}}const I=function(d,u){let h,f;const p={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},m=void 0!==u?u:e;for(h=0;h<c.length;++h)for(p[c[h]]=[],f=0;f<d.length;++f){const e=d[f][c[h]];void 0!==e&&p[c[h]].push(e)}function g(e){const n=e.id?"#"+e.id:"",o=e.getAttribute("class"),i=o?"."+o.split(" ").join("."):"";return t(m.tagName(e).toLowerCase()+n+i,{},[],void 0,e)}function v(e,t){return function(){if(0==--t){const t=m.parentNode(e);m.removeChild(t,e)}}}function w(e,t){var a,s;let c,d=e.data;if(void 0!==d){const t=null===(a=d.hook)||void 0===a?void 0:a.init;r(t)&&(t(e),d=e.data)}const u=e.children,h=e.sel;if("!"===h)i(e.text)&&(e.text=""),e.elm=m.createComment(e.text);else if(void 0!==h){const i=h.indexOf("#"),a=h.indexOf(".",i),f=i>0?i:h.length,g=a>0?a:h.length,v=-1!==i||-1!==a?h.slice(0,Math.min(f,g)):h,b=e.elm=r(d)&&r(c=d.ns)?m.createElementNS(c,v,d):m.createElement(v,d);for(f<g&&b.setAttribute("id",h.slice(f+1,g)),a>0&&b.setAttribute("class",h.slice(g+1).replace(/\./g," ")),c=0;c<p.create.length;++c)p.create[c](l,e);if(n(u))for(c=0;c<u.length;++c){const e=u[c];null!=e&&m.appendChild(b,w(e,t))}else o(e.text)&&m.appendChild(b,m.createTextNode(e.text));const y=e.data.hook;r(y)&&(null===(s=y.create)||void 0===s||s.call(y,l,e),y.insert&&t.push(e))}else e.elm=m.createTextNode(e.text);return e.elm}function b(e,t,n,o,i,r){for(;o<=i;++o){const i=n[o];null!=i&&m.insertBefore(e,w(i,r),t)}}function y(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<p.destroy.length;++t)p.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&y(n)}}}function k(e,t,n,o){for(var i,l;n<=o;++n){let o,a;const s=t[n];if(null!=s)if(r(s.sel)){y(s),o=p.remove.length+1,a=v(s.elm,o);for(let t=0;t<p.remove.length;++t)p.remove[t](s,a);const e=null===(l=null===(i=null==s?void 0:s.data)||void 0===i?void 0:i.hook)||void 0===l?void 0:l.remove;r(e)?e(s,a):a()}else m.removeChild(e,s.elm)}}function x(e,t,n){var o,l,c,d,u;const h=null===(o=t.data)||void 0===o?void 0:o.hook;null===(l=null==h?void 0:h.prepatch)||void 0===l||l.call(h,e,t);const f=t.elm=e.elm,g=e.children,v=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<p.update.length;++n)p.update[n](e,t);null===(d=null===(c=t.data.hook)||void 0===c?void 0:c.update)||void 0===d||d.call(c,e,t)}i(t.text)?r(g)&&r(v)?g!==v&&function(e,t,n,o){let r,l,c,d,u=0,h=0,f=t.length-1,p=t[0],g=t[f],v=n.length-1,y=n[0],C=n[v];for(;u<=f&&h<=v;)null==p?p=t[++u]:null==g?g=t[--f]:null==y?y=n[++h]:null==C?C=n[--v]:a(p,y)?(x(p,y,o),p=t[++u],y=n[++h]):a(g,C)?(x(g,C,o),g=t[--f],C=n[--v]):a(p,C)?(x(p,C,o),m.insertBefore(e,p.elm,m.nextSibling(g.elm)),p=t[++u],C=n[--v]):a(g,y)?(x(g,y,o),m.insertBefore(e,g.elm,p.elm),g=t[--f],y=n[++h]):(void 0===r&&(r=s(t,u,f)),l=r[y.key],i(l)?m.insertBefore(e,w(y,o),p.elm):(c=t[l],c.sel!==y.sel?m.insertBefore(e,w(y,o),p.elm):(x(c,y,o),t[l]=void 0,m.insertBefore(e,c.elm,p.elm))),y=n[++h]);(u<=f||h<=v)&&(u>f?(d=null==n[v+1]?null:n[v+1].elm,b(e,d,n,h,v,o)):k(e,t,u,f))}(f,g,v,n):r(v)?(r(e.text)&&m.setTextContent(f,""),b(f,null,v,0,v.length-1,n)):r(g)?k(f,g,0,g.length-1):r(e.text)&&m.setTextContent(f,""):e.text!==t.text&&(r(g)&&k(f,g,0,g.length-1),m.setTextContent(f,t.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,e,t)}}return function(e,t){let n,o,i;const r=[];for(n=0;n<p.pre.length;++n)p.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=g(e)),a(e,t)?x(e,t,r):(o=e.elm,i=m.parentNode(o),w(t,r),null!==i&&(m.insertBefore(i,t.elm,m.nextSibling(o)),k(i,[e],0,0))),n=0;n<r.length;++n)r[n].data.hook.insert(r[n]);for(n=0;n<p.post.length;++n)p.post[n]();return t}}([{create:f,update:f},{create:h,update:h}]);return function(e,t){let n,o;function i(){n=I(n||e,o?O(o):u("div#challenge-app.links.dropdown.rendered",[u("div.empty.loading","-"),M()]))}function r(n){o?o.update(n):(o=N(t,n,i),e.innerHTML=""),i()}return t.data?r(t.data):((e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},m),{headers:Object.assign(Object.assign({},p),g)}),t)).then((e=>v(e).json())))("/challenge").then(r,(e=>lichess.announce({msg:"Failed to load challenges"}))),{update:r}}}();
